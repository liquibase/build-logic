name: Build and Publish
env:
  java-version: 17
  # Set liquibase.version to version 0-SNAPSHOT because we are
  # building all required dependencies from the branches locally
  LIQUIBASE_VERSION: '0-SNAPSHOT'
on:
  workflow_call:
    inputs:
      core-branch:
        description: 'The liquibase core branch to checkout.'
        required: false
        type: string
        default: "DAT-16671"
      pro-branch:
        description: 'The liquibase commercial branch to checkout.'
        required: false
        type: string
        default: "DAT-16671"
      version:
        description: 'The version to mark the generated artifacts'
        required: true
        type: string

jobs:
  build:
    name: Build & Package java 17 - ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        name: Checkout OSS
        with:
          repository: liquibase/liquibase
          ref: ${{ inputs.core-version }}
          path: liquibase
          token: ${{ secrets.BOT_TOKEN }}

      - uses: actions/checkout@v4
        name: Checkout liquibase-pro
        with:
          repository: liquibase/liquibase-pro
          ref: ${{ inputs.core-version }}
          path: liquibase-pro
          token: ${{ secrets.BOT_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: "temurin"
          cache: "maven"

      - name: Set up Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}

      # look for dependencies in maven
      - name: maven-settings-xml-action
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: |
            [
              {
                "id": "liquibase",
                "url": "https://maven.pkg.github.com/liquibase/liquibase",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-pro",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-pro",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-checks",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-checks",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              }
            ]
          servers: |
            [
              {
                "id": "liquibase-pro",
                "username": "liquibot",
                "password": "${{ secrets.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                "id": "liquibase",
                "username": "liquibot",
                "password": "${{ secrets.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                  "id": "liquibase-checks",
                  "username": "liquibot",
                  "password": "${{ secrets.LIQUIBOT_PAT_GPM_ACCESS }}"
              }
            ]

      - name: Build Liquibase-pro
        # Set liquibase.version to version 0-SNAPSHOT because we are just building all the dependencies from the branches locally
        run: mvn -f liquibase-pro/pom-combined.xml clean install -DskipTests -P '!run-proguard' "-Dliquibase.version=${{ env.LIQUIBASE_VERSION }}"

      - uses: actions/checkout@v4
        if: ${{ inputs.version }}
        name: Checkout liquibase-checks # We need to checkout the scripting repo when this workflow is called from liquibase/liquibase
        with:
          repository: liquibase/liquibase-checks
          token: ${{ secrets.BOT_TOKEN }}

      - name: Build liquibase-checks version ${{ inputs.version }} jar
        run: |
          cd scripting
          mvn versions:set -DnewVersion='${{ inputs.version }}' -DgenerateBackupPoms=false
          cd ..
          mvn clean install -DskipTests=true -pl '!liquibase-scripting-integration-tests' "-Dliquibase.version=${{ env.LIQUIBASE_VERSION }}"
          mv scripting/target/liquibase-checks-${{ inputs.version }}.jar scripting/target/liquibase-checks-${{ matrix.os }}-${{ inputs.version }}.jar

      - name: get GITHUB_WORKSPACE
        if: always()
        shell: bash
        run: |
          echo "artifact_path=${GITHUB_WORKSPACE}/scripting/target/*.jar" >> $GITHUB_ENV

      - name: Save Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: liquibase-checks-${{ matrix.os }}-${{ inputs.version }}-artifacts
          path: ${{ env.artifact_path }}

      - name: Save Event File
        uses: actions/upload-artifact@v3
        with:
          name: Event File
          path: ${{ github.event_path }}


  combine_jars:
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: "temurin"
          cache: "maven"
          server-id: liquibase-checks
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      - name: Set up Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}

      # look for dependencies in maven
      - name: maven-settings-xml-action
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: |
            [
              {
                "id": "liquibase",
                "url": "https://maven.pkg.github.com/liquibase/liquibase",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-pro",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-pro",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-checks",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-checks",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              }
            ]
          servers: |
            [
              {
                "id": "liquibase-pro",
                "username": "liquibot",
                "password": "${{ secrets.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                "id": "liquibase",
                "username": "liquibot",
                "password": "${{ secrets.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                  "id": "liquibase-checks",
                  "username": "liquibot",
                  "password": "${{ secrets.LIQUIBOT_PAT_GPM_ACCESS }}"
              }
            ]

      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          name: liquibase-checks-ubuntu-latest-${{ inputs.version }}-artifacts
          path: /tmp

      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          name: liquibase-checks-macos-latest-${{ inputs.version }}-artifacts
          path: /tmp

      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          name: liquibase-checks-windows-latest-${{ inputs.version }}-artifacts
          path: /tmp

      - name: Run script for specific version
        run: |
          #Copy the .jar files from Linux, Windows, and Mac builds to /tmp/linux, /tmp/windows, and /tmp/mac
          rm -r -f /tmp/linux /tmp/windows /tmp/mac
          mkdir /tmp/linux /tmp/windows /tmp/mac
          unzip -d /tmp/linux /tmp/liquibase-checks-ubuntu-latest-${{ inputs.version }}.jar
          unzip -d /tmp/windows /tmp/liquibase-checks-windows-latest-${{ inputs.version }}.jar
          unzip -d /tmp/mac /tmp/liquibase-checks-macos-latest-${{ inputs.version }}.jar
          rm -r -f /tmp/liquibase-checks
          mkdir /tmp/liquibase-checks-${{ inputs.version }}
          cp -a /tmp/linux/* /tmp/liquibase-checks-${{ inputs.version }}/
          cp -a /tmp/windows/* /tmp/liquibase-checks-${{ inputs.version }}/
          cp -a /tmp/mac/* /tmp/liquibase-checks-${{ inputs.version }}/
          rm /tmp/liquibase-checks-${{ inputs.version }}/vfs/fileslist.txt
          cat /tmp/linux/vfs/fileslist.txt /tmp/windows/vfs/fileslist.txt /tmp/mac/vfs/fileslist.txt > /tmp/liquibase-checks-${{ inputs.version }}/vfs/fileslist.txt
          rm -f /tmp/liquibase-checks-${{ inputs.version }}.jar
          cd /tmp/liquibase-checks-${{ inputs.version }}/
          zip -r ../liquibase-checks-${{ inputs.version }}.jar *

      - uses: actions/checkout@v4
        name: Checkout liquibase-checks # We need to checkout the checks repo when this workflow is called from liquibase/liquibase
        with:
          repository: liquibase/liquibase-checks
          token: ${{ secrets.BOT_TOKEN }}

      - name: Publish specific version to GPM
        env:
          MAVEN_USERNAME: liquibot
          MAVEN_PASSWORD: ${{ secrets.LIQUIBOT_PAT_GPM_ACCESS }}
        run: |
          ls -ltr /tmp
          cd scripting
          mvn versions:set -DnewVersion='${{ inputs.version }}'
          cd ..
          mvn versions:set -DnewVersion='${{ inputs.version }}'
          mkdir -p scripting/target
          mv /tmp/*.jar scripting/target
          ls -ltr scripting/target/
          mvn deploy:deploy-file \
          -Dfile=scripting/target/liquibase-checks-${{ inputs.version }}.jar \
          -Dsources=scripting/target/liquibase-checks-${{ inputs.version }}-sources.jar \
          -Djavadoc=scripting/target/liquibase-checks-${{ inputs.version }}-javadoc.jar \
          -DrepositoryId=liquibase \
          -Durl=https://maven.pkg.github.com/liquibase/liquibase-checks \
          -DpomFile=scripting/pom.xml

      - name: Upload multiplatform artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.version }}-multiplatform-artifacts
          path: |
            scripting/target/*