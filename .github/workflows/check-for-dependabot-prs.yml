name: Check for open Dependabot PRs
on:
  workflow_call:
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  pull-requests: read

jobs:
  check_for_prs:
    name: Check for open Dependabot PRs
    runs-on: ubuntu-latest
    steps:
      - name: Skip check if PR creator is dependabot
        if: github.event.pull_request.user.login == 'dependabot[bot]'
        run: |
          echo "Skipping check because this PR was created by dependabot"
          
      - name: Check for open Dependabot PRs
        if: github.event.pull_request.user.login != 'dependabot[bot]'
        run: |
          echo "Checking for open Dependabot PRs in $GITHUB_REPOSITORY..."
          open_prs=$(gh pr list --repo $GITHUB_REPOSITORY --author dependabot[bot] --state open --json title,url \
            | jq -r '.[] | "\(.title) \(.url)"')

          if [ -n "$open_prs" ]; then
            echo "Found open Dependabot PRs:"
            echo "$open_prs"
            exit 1
          else
            echo "No open Dependabot PRs found."
          fi
