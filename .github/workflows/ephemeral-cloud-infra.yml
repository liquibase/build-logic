# Terraform Action to lint and apply updated redirects
name: Ephemeral Cloud Infrastructure
on:
 workflow_call:
    inputs:
        action:
            description: 'Deploy or destroy the ephemeral cloud infrastructure'
            required: true
            type: string
            default: 'deploy'

jobs:
  ephemeral-cloud-infra:
    name: ${{ inputs.action}} Ephemeral Cloud Infrastructure
    runs-on: ubuntu-latest
    permissions: write-all
    env:
      SPACELIFT_API_KEY_ENDPOINT: ${{ secrets.SPACELIFT_API_KEY_ENDPOINT }}
      SPACELIFT_API_KEY_ID: ${{ secrets.SPACELIFT_API_KEY_ID }}
      SPACELIFT_API_KEY_SECRET: ${{ secrets.SPACELIFT_API_KEY_SECRET }}

    steps:
      - name: Checkout branch with draft redirects
        uses: actions/checkout@v4
        with:
          ref: DAT-16824
          repository: liquibase/liquibase-infrastructure
          token: ${{ secrets.BOT_TOKEN }}

      - name: Install spacectl
        uses: spacelift-io/setup-spacectl@main
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}

      - name: Terraform Init
        working-directory: test-automation-ephemeral/stack
        id: init
        run: terraform init

      - name: Create ephemeral stack
        working-directory: test-automation-ephemeral/stack
        if: ${{ inputs.action }} == 'deploy'
        run: |
            terraform apply -auto-approve
            echo "EPHEMERAL_STACK_ID=$(terraform output -raw ephemeral_stack_id)" >> $GITHUB_ENV
            echo "The ephemeral stack ID is $EPHEMERAL_STACK_ID"

      - name: Create ephemeral infra
        working-directory: test-automation-ephemeral/infra
        if: ${{ inputs.action }} == 'deploy'
        run: |
            spacectl stack deploy --id $EPHEMERAL_STACK_ID --auto-confirm
    
      - name: Destroy ephemeral infra
        working-directory: test-automation-ephemeral/infra
        if: ${{ inputs.action }} == 'destroy'
        run: |
            spacectl stack destroy --id $EPHEMERAL_STACK_ID --auto-confirm

      - name: Destroy ephemeral stack
        working-directory: test-automation-ephemeral/stack
        if: ${{ inputs.action }} == 'destroy'
        run: |
            terraform destroy -auto-approve
