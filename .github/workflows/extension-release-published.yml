name: Release Extension to Sonatype

on:
  workflow_call:
    inputs:
      extraCommand:
        description: "Specify it if you want to run an extra command before attaching the artifact"
        required: false
        default: ""
        type: string
      nameSpace:
        description: "xsd namespace"
        required: false
        default: ""
        type: string
      artifactPath:
        description: "Specify the path to the artifacts that should be attached to the build. Useful for multi-module extensions."
        required: false
        default: "."
        type: string
      javaBuildVersion:
        description: "Java version to use when building the extension"
        required: false
        default: "21"
        type: string
      deployToMavenCentral:
        description: "Specify it if you want to deploy to maven"
        required: false
        default: true
        type: boolean
      dry_run:
        description: "Specify it if you want to run a dry run"
        required: false
        default: false
        type: boolean
      dry_run_version:
        description: "The version of the dry-run release"
        required: false
        type: string
      dry_run_release_id:
        description: "The release id of the dry-run release"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  packages: write
  id-token: write

jobs:
  maven-release:
    uses: liquibase/build-logic/.github/workflows/extension-release-prepare.yml@main
    if: inputs.deployToMavenCentral == true
    secrets: inherit
    with:
      extraCommand: ${{ inputs.extraCommand }}
      javaBuildVersion: ${{ inputs.javaBuildVersion }}

  release:
    if: inputs.deployToMavenCentral == true
    runs-on: ubuntu-latest
    needs: maven-release
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Set up Java for publishing to Maven Central Repository
        uses: actions/setup-java@v5
        with:
          java-version: ${{ inputs.javaBuildVersion }}
          distribution: "temurin"
          cache: "maven"

      # look for dependencies in maven
      - name: maven-settings-xml-action
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: |
            [
              {
                "id": "liquibase",
                "url": "https://maven.pkg.github.com/liquibase/liquibase",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-pro",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-pro",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              }
            ]
          servers: |
            [
              {
                "id": "liquibase-pro",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                "id": "liquibase",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              }
            ]

      - name: Configure Git
        run: |
          git config user.name "liquibot"
          git config user.email "liquibot@liquibase.org"

      - name: Run extra command
        working-directory: ${{ inputs.artifactPath }}
        if: inputs.extraCommand != ''
        run: |
          ${{ inputs.extraCommand }}

      - name: Build release artifacts
        working-directory: ${{ inputs.artifactPath }}
        id: build-release-artifacts
        continue-on-error: true
        run: |
          mvn -B release:clean release:prepare -Darguments="-Dmaven.javadoc.skip=true -Dmaven.test.skipTests=true -Dmaven.test.skip=true -Dmaven.deploy.skip=true" -DcheckModificationExcludeList=** -DignoreSnapshots=true -DreleaseVersion=${{ github.event.inputs.liquibaseVersion }} -DpushChanges=false
          git reset HEAD~ --hard

      - name: Get Artifact ID
        working-directory: ${{ inputs.artifactPath }}
        id: get-artifact-id
        run: echo "artifact_id=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)" >> $GITHUB_ENV

      - name: Download Release Artifacts
        uses: robinraju/release-downloader@v1.12
        with:
          tag: "${{ github.event.release.tag_name }}"
          fileName: "*"
          out-file-path: ${{ inputs.artifactPath }}

      - name: Publish to Maven Central
        working-directory: ${{ inputs.artifactPath }}
        env:
          MAVEN_USERNAME: ${{ env.SONATYPE_USERNAME }}
          MAVEN_PASSWORD: ${{ env.SONATYPE_TOKEN }}
        run: |
          version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          groupId=$(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout)

          # Convert groupId dots to directory separators
          groupPath=$(echo "$groupId" | tr '.' '/')

          # Process all JAR files (supports multi-module projects)
          for jar_file in *-${version}.jar; do
            if [ -f "$jar_file" ] && [[ ! "$jar_file" =~ (sources|javadoc)\.jar$ ]]; then
              # Extract artifact name (remove version and .jar)
              artifact_name="${jar_file%-${version}.jar}"
              echo "Processing artifact: $artifact_name"

              # Create Maven repository layout structure for this artifact
              mkdir -p "bundle/${groupPath}/${artifact_name}/${version}"

              # Copy all files for this artifact (jar, pom, sources, javadoc, signatures, checksums)
              # Skip files containing "-full" in their names
              for file in ${artifact_name}-${version}*; do
                if [[ ! "$file" == *"-full"* ]] && [ -f "$file" ]; then
                  cp "$file" "bundle/${groupPath}/${artifact_name}/${version}/"
                  echo "  Copied: $file"
                fi
              done
            fi
          done

          # Create the bundle zip file
          cd bundle
          zip -r ../central-bundle.zip .
          cd ..

          # Create base64 encoded credentials for Bearer auth
          AUTH_HEADER=$(printf "%s:%s" "${MAVEN_USERNAME}" "${MAVEN_PASSWORD}" | base64 -w 0)

          # Upload bundle to Central Portal using curl with proper authentication
          echo "Uploading bundle to Central Portal..."
          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${AUTH_HEADER}" \
            -F "bundle=@central-bundle.zip" \
            "https://central.sonatype.com/api/v1/publisher/upload?publishingType=USER_MANAGED&name=${{ env.artifact_id }}-${version}")

          # Parse response
          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
          DEPLOYMENT_ID=$(echo "$UPLOAD_RESPONSE" | head -n1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Deployment ID: $DEPLOYMENT_ID"

          if [ "$HTTP_CODE" != "201" ]; then
            echo "Upload failed with HTTP status $HTTP_CODE"
            echo "Response: $DEPLOYMENT_ID"
            exit 1
          fi

          echo "Bundle uploaded successfully to Central Portal"
          echo "Deployment ID: $DEPLOYMENT_ID"
          echo "Visit https://central.sonatype.com/publishing/deployments to view and publish your deployment"

  dry-run-release:
    if: ${{ inputs.dry_run == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Set up Java for publishing to Maven Central Repository
        uses: actions/setup-java@v5
        with:
          java-version: ${{ inputs.javaBuildVersion }}
          distribution: "temurin"
          cache: "maven"

      # look for dependencies in maven
      - name: maven-settings-xml-action
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: |
            [
              {
                "id": "liquibase",
                "url": "https://maven.pkg.github.com/liquibase/liquibase",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-pro",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-pro",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "dry-run-sonatype-nexus-staging",
                "url": "https://repo.liquibase.net/repository/dry-run-sonatype-nexus-staging/",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true"
                }
              }
            ]
          servers: |
            [
              {
                "id": "liquibase-pro",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                "id": "liquibase",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                "id": "dry-run-sonatype-nexus-staging",
                "username": "${{ env.REPO_LIQUIBASE_NET_USER }}",
                "password": "${{ env.REPO_LIQUIBASE_NET_PASSWORD }}"
              }
            ]

      - name: Configure Git
        run: |
          git config user.name "liquibot"
          git config user.email "liquibot@liquibase.org"

      - name: Get Artifact ID
        working-directory: ${{ inputs.artifactPath }}
        id: get-artifact-id
        run: echo "artifact_id=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)" >> $GITHUB_ENV

      - name: Download Release Artifacts
        uses: robinraju/release-downloader@v1.12
        with:
          releaseId: "${{ inputs.dry_run_release_id }}"
          fileName: "*"
          out-file-path: ${{ inputs.artifactPath }}

      - name: Rename SNAPSHOTS to dry_run version
        working-directory: ${{ inputs.artifactPath }}
        run: |
          # Validate and sanitize dry_run_version input (Maven-style: letters, digits, dots, hyphens, underscores)
          raw_version="${{ inputs.dry_run_version }}"
          if [[ ! "$raw_version" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "ERROR: Invalid dry_run_version format: '$raw_version'"
            echo "Version must contain only letters, digits, dots, hyphens, and underscores"
            exit 1
          fi
          version="$raw_version"
          echo "Validated version: $version"

          # Rename all SNAPSHOT files (supports both single and multi-module projects)
          for file in *-SNAPSHOT*; do
            if [ -f "$file" ]; then
              # Remove -SNAPSHOT- and -SNAPSHOT from filenames
              new_file=$(echo "$file" | sed "s/-SNAPSHOT-/-/g" | sed "s/-SNAPSHOT//g")
              if [ "$file" != "$new_file" ]; then
                echo "Renaming: $file -> $new_file"
                mv "$file" "$new_file"
              fi
            fi
          done

          # Find and update all pom files in current directory (supports multi-module)
          ls -l *.pom || echo "No POM files found"

          # Use sanitized version variable with quoted glob pattern to prevent glob expansion
          pom_pattern="*-${version}.pom"
          pom_files_found=false
          for pom_file in $pom_pattern; do
            # Check if glob pattern matched actual files
            if [ -f "$pom_file" ]; then
              pom_files_found=true
              echo "Updating $pom_file - removing -SNAPSHOT from version tags"
              sed -i 's/<version>\(.*\)-SNAPSHOT<\/version>/<version>\1<\/version>/g' "$pom_file"
              echo "✓ Updated $pom_file"
            fi
          done

          # Fail if no files matched the pattern
          if [ "$pom_files_found" = false ]; then
            echo "ERROR: No POM files matching pattern '$pom_pattern' were found"
            exit 1
          fi

      - name: Publish to Maven Central
        working-directory: ${{ inputs.artifactPath }}
        env:
          MAVEN_USERNAME: ${{ env.REPO_LIQUIBASE_NET_USER }}
          MAVEN_PASSWORD: ${{ env.REPO_LIQUIBASE_NET_PASSWORD }}
          DRY_RUN_VERSION: ${{ inputs.dry_run_version }}
        run: |
          # Validate and sanitize DRY_RUN_VERSION input (Maven-style: letters, digits, dots, hyphens, underscores)
          raw_version="$DRY_RUN_VERSION"
          if [[ ! "$raw_version" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "ERROR: Invalid dry_run_version format: '$raw_version'"
            echo "Version must contain only letters, digits, dots, hyphens, and underscores"
            exit 1
          fi
          version="$raw_version"
          echo "Validated version: $version"

          # Use sanitized version variable with quoted glob pattern to prevent glob expansion
          jar_pattern="*-${version}.jar"
          jar_files_found=false

          # Find all JAR files (excluding sources and javadoc) and deploy each (supports multi-module)
          for jar_file in $jar_pattern; do
            # Check if glob pattern matched actual files
            if [ -f "$jar_file" ] && [[ ! "$jar_file" =~ (sources|javadoc)\.jar$ ]]; then
              jar_files_found=true
              # Extract artifact name (remove version and .jar)
              artifact_name="${jar_file%-${version}.jar}"
              echo "Publishing artifact: $artifact_name"

              # Deploy with all associated files (quote all variable expansions to prevent injection)
              mvn -B org.apache.maven.plugins:maven-deploy-plugin:3.0.0-M1:deploy-file \
                          -Durl=https://repo.liquibase.net/repository/dry-run-sonatype-nexus-staging/ \
                          -DrepositoryId=dry-run-sonatype-nexus-staging \
                          -DpomFile="${artifact_name}-${version}.pom" \
                          -DgeneratePom=false \
                          -Dfile="${artifact_name}-${version}.jar" \
                          -Dsources="${artifact_name}-${version}-sources.jar" \
                          -Djavadoc="${artifact_name}-${version}-javadoc.jar" \
                          -Dfiles="${artifact_name}-${version}.jar.asc,${artifact_name}-${version}-sources.jar.asc,${artifact_name}-${version}-javadoc.jar.asc,${artifact_name}-${version}.pom.asc" \
                          -Dtypes=jar.asc,jar.asc,jar.asc,pom.asc \
                          -Dclassifiers=,sources,javadoc,
              echo "✓ Published $artifact_name"
            fi
          done

          # Fail if no JAR files matched the pattern
          if [ "$jar_files_found" = false ]; then
            echo "ERROR: No JAR files matching pattern '$jar_pattern' were found"
            exit 1
          fi

  deploy_xsd:
    if: inputs.nameSpace != '' && inputs.deployToMavenCentral == true && inputs.dry_run == false
    name: Upload xsds
    runs-on: ubuntu-22.04
    steps:
      - name: Download xsd files
        uses: actions/checkout@v4
        with:
          # Relative path under $GITHUB_WORKSPACE to place the repository
          path: ${{ github.event.repository.name }}
          repository: "liquibase/${{ github.event.repository.name }}"

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.AWS_PROD_GITHUB_OIDC_ROLE_ARN_BUILD_LOGIC }}
          aws-region: us-east-1

      - name: Upload to s3
        working-directory: ${{ inputs.artifactPath }}
        # aws s3 sync syncs directories and S3 prefixes.
        run: |
          aws s3 sync ${{ github.event.repository.name }}/src/main/resources/www.liquibase.org/xml/ns/${{ inputs.nameSpace }}/ s3://liquibaseorg-origin/xml/ns/${{ inputs.nameSpace }}/ --content-type application/octet-stream --only-show-errors

      - name: Index.htm file upload
        working-directory: ${{ inputs.artifactPath }}
        # List all xsd and htm files in repository. Copy index.htm to temporary folder
        # Add links for all xsd files to index.htm file (except liquibase-${{ inputs.nameSpace }}-latest.xsd and index.htm)
        # Sync index.htm with the s3
        run: |
          search_dir=${{ github.event.repository.name }}/src/main/resources/www.liquibase.org/xml/ns/${{ inputs.nameSpace }}
          filenames=`ls -1 $search_dir`
          mkdir index-file
          cp $search_dir/index.htm index-file/
          for entry in $filenames
          do
            if [[ "$entry" != "${{ github.event.repository.name }}-latest.xsd" ]] && [[ "$entry" != "index.htm" ]] ;then
              sed -ie "s/<\/ul>/  <li><a href=\"\/xml\/ns\/${{ inputs.nameSpace }}\/${entry}\">${entry}<\/a><\/li>\n<\/ul>/" index-file/index.htm
            fi
          done

          aws s3 sync index-file s3://liquibaseorg-origin/xml/ns/${{ inputs.nameSpace }}/ --only-show-errors
          
