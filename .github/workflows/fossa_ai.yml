name: FOSSA Compliance and AI Analysis

on:
  workflow_call:
    inputs:
      check_snippets:
        description: "Enable FOSSA Snippet Scanning (adds --snippet-scan to analyze)"
        required: false
        default: false
        type: boolean
      check_ai_generated_code:
        description: "Run FOSSA AI Generated Code Detection"
        required: false
        default: false
        type: boolean
      generate_fossa_3p_license_report:
        description: "Generate FOSSA 3P License Report"
        required: false
        default: false
        type: boolean

jobs:
  fossa-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read        # For code checkout
      pull-requests: write  # For adding/removing PR labels
      actions: read         # For artifact-uploads that happen in the same workflow, dont need actions: write
      id-token: write       # For AWS credentials

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Get Fossa Configuration
        if: ${{ inputs.check_ai_generated_code }}
        run: |
          curl -o $PWD/.github/.fossa.yml https://raw.githubusercontent.com/liquibase/build-logic/main/.github/.fossa.yml

      - name: Install FOSSA CLI
        run: |
          curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash

      - name: Run FOSSA Analyze with AI Generated Code Detection
        id: analyze-ai
        if: ${{ inputs.check_ai_generated_code }}
        env:
          FOSSA_API_KEY: ${{ env.FOSSA_API_KEY }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # https://github.com/fossas/fossa-cli/tree/master/docs/references/subcommands/analyze
          mkdir patch
          cp $PWD/.github/.fossa.yml patch/.fossa.yml
          # Get changed files excluding deleted ones (--diff-filter=d excludes deleted files)
          CHANGED_FILES=$(git diff --name-only --diff-filter=d HEAD~1 HEAD)
          if [ -n "$CHANGED_FILES" ]; then
            # Export the full content of changed files to 'patch.zip'
            printf '%s\n' "$CHANGED_FILES" | zip patch.zip -@
            unzip patch.zip -d patch/
            # Analyze the changes using FOSSA and redirect output to analyze.out
            fossa analyze -p "$REPO_NAME" patch -o 2>&1 | tee analyze.out
          else
            echo "No files to analyze (all changes are deletions or no changes found)"
            echo "Skipping AI code detection - no analyzable files" > analyze.out
          fi

      - name: Run FOSSA Analyze
        id: analyze
        env:
          FOSSA_API_KEY: ${{ env.FOSSA_API_KEY }}
          REPO_NAME: ${{ github.event.repository.name }}
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
          SNIPPET_FLAG: ${{ inputs.check_snippets && '--snippet-scan' || '' }}
        run: |
          # https://github.com/fossas/fossa-cli/tree/master/docs/references/subcommands/analyze
          # Run the full analyze on the current branch to be checked by the test command
          # --snippet-scan is added when check_snippets is enabled (replaces deprecated 'fossa snippets' command)
          fossa analyze -p "$REPO_NAME" -b "$BRANCH_NAME" $SNIPPET_FLAG 2>&1 | tee analyze_no_ai.out

      - name: Run FOSSA Test
        id: test
        env:
          FOSSA_API_KEY: ${{ env.FOSSA_API_KEY }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # https://github.com/fossas/fossa-cli/tree/master/docs/references/subcommands/test
          fossa test -p "$REPO_NAME" 2>&1 | tee test.out
          FILE="test.out"
          if [ -f "$FILE" ]; then
              if grep -q "Test passed" "$FILE"; then
                  echo "The file '$FILE' contains 'Test passed'."
              else
                  echo "The file '$FILE' does not contain 'Test passed'."
                  exit 1
              fi
          else
              echo "Error: The file '$FILE' does not exist."
          fi

      - name: Label PR with AI label
        if: ${{ inputs.check_ai_generated_code }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const analyze_file = fs.readFileSync('analyze.out', 'utf8')
            if (analyze_file.includes('GitHub Copilot generated code') || analyze_file.includes('AI generated code')) {
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['AI Generated Code']
              })
            }
            else {
              github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'AI Generated Code'
              })
            }

      - name: Run FOSSA 3Party License Report
        if: ${{ inputs.generate_fossa_3p_license_report }}
        env:
          FOSSA_API_KEY: ${{ env.FOSSA_API_KEY }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # https://github.com/fossas/fossa-cli/blob/master/docs/references/subcommands/report.md
          fossa report -p "$REPO_NAME" attribution --format html 2>&1 | tee fossa-3party-license-report.html

      - name: Archive FOSSA 3Party License Report
        if: ${{ inputs.generate_fossa_3p_license_report }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: fossa-3party-license-report
          path: fossa-3party-license-report.html
