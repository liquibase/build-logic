name: Homebrew PR Tracking

on:
  schedule:
    # Run every midnight UTC
    # This will check for Homebrew PRs and update tracking issues
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-homebrew-prs:
    runs-on: ubuntu-latest
    outputs:
      pr_open: ${{ steps.check-prs.outputs.pr_open }}
    steps:
      - name: Check and close tracking issues
        id: check-prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |    
            // Get all open issues with 'homebrew-tracking' label
            const issues = await github.rest.issues.listForRepo({
              owner: 'liquibase',
              repo: 'liquibase',
              labels: 'homebrew-tracking',
              state: 'open'
            });

            const issue = issues.data[0]; // Get the first issue
            console.log(`Found ${issues.data.length} open tracking issues`);

            // Get the label from the issue that has the PR number
            const prNumberLabel = issue.labels.find(label => label.name.startsWith('PR-'));
            const prNumber = prNumberLabel.split('-')[1]; // Extract the PR number from the label

            // Check if the PR is still open
            const pr = await github.rest.pulls.get({
              owner: 'Homebrew',
              repo: 'homebrew-core',
              pull_number: prNumber
            });

            if (pr.data.state === 'open') {
              console.log(`PR #${prNumber} is still open. Will try again tomorrow on schedule.`);
              // Set github output to indicate pr is still open
              return {
                pr_open: true,
              };
            } else {
              console.log(`Homebrew PR #${prNumber} is closed or merged. Closing tracking liquibase issue ${issue.number}.`);

              // Close the tracking issue
              await github.rest.issues.update({
                owner: 'liquibase',
                repo: 'liquibase',
                issue_number: issue.number,
                state: 'closed'
              });

              return {
                pr_open: false
              };
            }

  notify:
    needs: check-homebrew-prs
    if: needs.check-homebrew-prs.outputs.pr_open == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: ${{ job.status }}
          SLACK_MESSAGE: "Homebrew PR tracking issue has been closed as the PR is no longer open."
          SLACK_TITLE: "Homebrew PR Status Update"
          SLACK_USERNAME: liquibot
          SLACK_WEBHOOK: ${{ secrets.NIGHTLY_BUILDS_SLACK_WEBHOOK }}
          SLACK_ICON_EMOJI: ":robot_face:"
          SLACK_FOOTER: "${{ github.repository }}"
          SLACK_LINK_NAMES: true