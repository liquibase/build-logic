name: DEB packaging
on:
  workflow_call:
    inputs:
      groupId:
        description: 'Value from the groupId field in pom.xml. i.e. org.liquibase'
        required: true
        type: string
      artifactId:
        description: 'Value from the artifactId field in pom.xml. i.e. liquibase'
        required: true
        type: string
      version:
        description: 'Value from the version field in pom.xml. i.e 4.23.0'
        type: string
    secrets:
      AWS_PROD_ACCESS_KEY_ID:
        description: 'AWS_PROD_ACCESS_KEY_ID from the caller workflow'
        required: true
      AWS_PROD_SECRET_ACCESS_KEY:
        description: 'AWS_PROD_SECRET_ACCESS_KEY from the caller workflow'
        required: true
      GPG_SECRET:
        description: 'GPG_SECRET from the caller workflow'
        required: true
      GPG_PASSPHRASE:
        description: 'GPG_PASSPHRASE from the caller workflow'
        required: true
      GPG_SECRET_KEY_ID:
        description: 'GPG_SECRET_KEY_ID from the caller workflow'
        required: true


env:
  MAVEN_VERSION: '3.9.5'

jobs:

  upload_deb:
      name: Upload ${{ inputs.artifactId }} deb package
      runs-on: ubuntu-22.04
      steps:
        - uses: actions/checkout@v4

        - name: Set up Java
          uses: actions/setup-java@v3
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: 'maven'
            gpg-private-key: ${{ secrets.GPG_PRIVGPG_SECRETTE_KEY }}
            gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}
          env:
            GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

        - name: Set up Maven
          uses: stCarolas/setup-maven@v4.5
          with:
            maven-version: ${{ env.MAVEN_VERSION }}

        - name: Set up Ruby
          uses: ruby/setup-ruby@v1
          with:
            ruby-version: 3.1.4

        - name: Get Reusable Files
          run: |
            # Under the src folder is where specific packages files live. The GitHub action inputs will modify the universal package-deb-pom.xml to tell the process which assets to use during the packaging step
            mkdir -p $PWD/.github/src/${{ inputs.artifactId }}/deb/control
            mkdir -p $PWD/.github/src/${{ inputs.artifactId }}/main/archive
            curl -o $PWD/.github/src/${{ inputs.artifactId }}/deb/control/control https://raw.githubusercontent.com/liquibase/build-logic/v0.5.5/src/${{ inputs.artifactId }}/deb/control/control
            curl -o $PWD/.github/src/${{ inputs.artifactId }}/deb/control/postinst https://raw.githubusercontent.com/liquibase/build-logic/v0.5.5/src/${{ inputs.artifactId }}/deb/control/postinst
            curl -o $PWD/.github/src/${{ inputs.artifactId }}/main/archive/${{ inputs.artifactId }}-env.sh https://raw.githubusercontent.com/liquibase/build-logic/v0.5.5/src/${{ inputs.artifactId }}/main/archive/${{ inputs.artifactId }}-env.sh
            curl -o $PWD/.github/package-deb-pom.xml https://raw.githubusercontent.com/liquibase/build-logic/v0.5.5/.github/package-deb-pom.xml
            curl -o $PWD/.github/sign_artifact.sh https://raw.githubusercontent.com/liquibase/build-logic/v0.5.5/.github/sign_artifact.sh
            chmod +x $PWD/.github/sign_artifact.sh

        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_PROD_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_PROD_SECRET_ACCESS_KEY }}
            aws-region: us-east-1

        - name: Download ${{ inputs.artifactId }} Release
          run: |
            mkdir -p $PWD/.github/target
            # Creating deb packages needs to get release assets from somewhere so be sure to follow this pattern in the artifact repo: https://github.com/liquibase/ARTIFACT_ID/releases/download/vVERSION/ARTIFACT_ID-VERSION.tar.gz
            wget -q -O $PWD/.github/target/${{ inputs.artifactId }}-${{ inputs.version }}.tar.gz https://github.com/liquibase/${{ inputs.artifactId }}/releases/download/v${{ inputs.version }}/${{ inputs.artifactId }}-${{ inputs.version }}.tar.gz

        - name: Build ${{ inputs.artifactId }} deb package
          run: |
            mvn package -f $PWD/.github/package-deb-pom.xml -DgroupId=${{ inputs.groupId }} -DartifactId=${{ inputs.artifactId }} -Drevision=${{ inputs.version }} -DskipTests

        - name: Install deb-s3 gem
          run: gem install deb-s3

        - name: Upload ${{ inputs.artifactId }} deb package
          run: |
            sudo apt install pinentry-tty expect
            echo "2" | sudo update-alternatives --config pinentry
            echo "${{ secrets.GPG_SECRET }}" | gpg --batch --import --pinentry-mode loopback --passphrase "${{ secrets.GPG_PASSPHRASE }}"
            export GPG_TTY=$(tty)
            echo '${{ secrets.GPG_PASSPHRASE }}' > pass.txt
            #deb-s3 upload --preserve-versions --sign "${{ secrets.GPG_SECRET_KEY_ID }}" --gpg-options "\-\-pinentry-mode loopback \-\-batch \-\-passphrase\-file pass.txt \-\-yes \-\-quiet" --bucket repo.liquibase.com $PWD/.github/target/${{ inputs.artifactId }}-${{ inputs.version }}.deb

        - name: Convert deb to rpm
          run: |
            sudo apt-get update
            sudo apt-get install -y alien gnupg-agent
            sudo alien --to-rpm --keep-version $PWD/.github/target/${{ inputs.artifactId }}-${{ inputs.version }}.deb

        - name: Import GPG key
          id: import_gpg
          uses: crazy-max/ghaction-import-gpg@v6
          with:
            gpg_private_key: ${{ secrets.GPG_SECRET }}
            passphrase: ${{ secrets.GPG_PASSPHRASE }}

        - name: Sign rpm package
          run: |
            echo "%__gpg_name Liquibase <support@liquibase.org>" > github_action_macros
            echo "%__gpg_sign_cmd %{__gpg} gpg --no-verbose --no-armor --batch --pinentry-mode loopback %{?_gpg_digest_algo:--digest-algo %{_gpg_digest_algo}} --no-secmem-warning -u "%{_gpg_name}" -sbo %{__signature_filename} %{__plaintext_filename}" >> github_action_macros
            export RPM_MACROS_PATH=$(pwd)/github_action_macros
            export GPG_TTY=$(tty)
            echo "use-agent" >> $HOME/.gnupg/gpg.conf
            echo "pinentry-mode loopback" >> $HOME/.gnupg/gpg.conf
            echo "allow-preset-passphrase" >> $HOME/.gnupg/gpg-agent.conf
            echo "allow-loopback-pinentry" >> $HOME/.gnupg/gpg-agent.conf
            gpg-connect-agent reloadagent /bye
            keygrip=$(gpg --with-keygrip -K ${{ secrets.GPG_SECRET_KEY_ID }} | grep 'Keygrip' | head -1 | awk '{print $3}')
            hexpassphrase=$(echo -n ${{ secrets.GPG_PASSPHRASE }} | hexdump -v -e '/1 "%02X"'; echo)
            gpg-connect-agent "preset_passphrase $keygrip -1 $hexpassphrase" /bye
            gpg --export -a ${{ secrets.GPG_SECRET_KEY_ID }} > public.key
            rpm --import public.key
            rpm -qa gpg-pubkey*
            sudo rpm --define "_gpg_sign_cmd_extra_args --batch --pinentry-mode loopback" --define "_gpg_name ${{ secrets.GPG_SECRET_KEY_ID }}" --addsign ${{ inputs.artifactId }}-${{ inputs.version }}-1.noarch.rpm

        - name: Upload rpm package
          run: |
            sudo apt-get install -y libcurl4-openssl-dev libbz2-dev libxml2-dev libssl-dev zlib1g-dev pkg-config libglib2.0-dev liblzma-dev libsqlite0-dev libsqlite3-dev librpm-dev libzstd-dev python3 cmake
            mkdir createrepo_folder
            cd createrepo_folder
            git clone https://github.com/rpm-software-management/createrepo_c
            cd createrepo_c
            mkdir build
            cd build
            cmake .. -DWITH_ZCHUNK=NO -DWITH_LIBMODULEMD=NO
            make -j
            cp src/createrepo_c  /opt/createrepo
            cd ../../..
            mkdir -p $PWD/yum/noarch
            aws s3 ls s3://repo.liquibase.com/yum/noarch/ | grep -E '\.rpm$' | awk '{print $4}' | xargs -I {} aws s3 cp s3://repo.liquibase.com/yum/noarch/{} $PWD/yum/noarch
            /opt/createrepo -h
            /opt/createrepo -dp $PWD/yum/noarch
            ./.github/sign_artifact.sh $PWD/yum/noarch/repodata/repomd.xml
            aws s3 sync $PWD/yum s3://repo.liquibase.com/yum

