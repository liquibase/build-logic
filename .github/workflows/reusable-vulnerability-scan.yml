name: Reusable Vulnerability Scan

on:
  workflow_call:
    inputs:
      mode:
        description: 'Extraction mode: docker or tarball'
        required: true
        type: string
      source:
        description: 'Docker image reference OR tarball artifact name'
        required: true
        type: string
      image_name:
        description: 'Image name for reporting (docker mode)'
        required: false
        type: string
        default: ''
      image_tag:
        description: 'Image tag for reporting (docker mode)'
        required: false
        type: string
        default: ''
      version:
        description: 'Version string for reporting (tarball mode)'
        required: false
        type: string
        default: ''
      scan_scope:
        description: 'Scan scope: full or python-only'
        required: false
        type: string
        default: 'full'
      fail_on_vulnerabilities:
        description: 'Whether to fail workflow on HIGH/CRITICAL vulnerabilities'
        required: false
        type: boolean
        default: true
      upload_sarif:
        description: 'Upload SARIF to GitHub Security tab'
        required: false
        type: boolean
        default: false
      sarif_category:
        description: 'Category for SARIF upload'
        required: false
        type: string
        default: 'vulnerability-scan'
      generate_sbom:
        description: 'Generate SBOM with Syft (docker mode only)'
        required: false
        type: boolean
        default: true
      build_logic_ref:
        description: 'build-logic branch/tag to use'
        required: false
        type: string
        default: 'master'
    outputs:
      total_vulnerabilities:
        description: 'Total HIGH/CRITICAL vulnerability count'
        value: ${{ jobs.vulnerability-scan.outputs.total_vulns }}
      surface_vulnerabilities:
        description: 'Surface scan vulnerability count'
        value: ${{ jobs.vulnerability-scan.outputs.surface_vulns }}
      deep_vulnerabilities:
        description: 'Deep scan vulnerability count'
        value: ${{ jobs.vulnerability-scan.outputs.deep_vulns }}
      grype_vulnerabilities:
        description: 'Grype scan vulnerability count'
        value: ${{ jobs.vulnerability-scan.outputs.grype_vulns }}
      scan_status:
        description: 'Scan status: pass or fail'
        value: ${{ jobs.vulnerability-scan.outputs.scan_status }}

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    outputs:
      total_vulns: ${{ steps.analyze.outputs.total_vulns }}
      surface_vulns: ${{ steps.analyze.outputs.surface_vulns }}
      deep_vulns: ${{ steps.analyze.outputs.deep_vulns }}
      grype_vulns: ${{ steps.analyze.outputs.grype_vulns }}
      scan_status: ${{ steps.check.outputs.status }}

    steps:
      - name: Checkout build-logic
        uses: actions/checkout@v4
        with:
          repository: liquibase/build-logic
          ref: ${{ inputs.build_logic_ref }}
          path: build-logic

      - name: Download tarball artifact
        if: inputs.mode == 'tarball'
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.source }}
          path: ./artifacts

      - name: Find tarball file
        if: inputs.mode == 'tarball'
        id: find-tarball
        run: |
          TARBALL=$(find ./artifacts -name "*.tar.gz" -type f | head -1)
          if [ -z "$TARBALL" ]; then
            echo "Error: No tarball found in artifact"
            exit 1
          fi
          echo "tarball_path=$TARBALL" >> "$GITHUB_OUTPUT"
          echo "Found tarball: $TARBALL"

      - name: Pull Docker image
        if: inputs.mode == 'docker'
        run: docker pull ${{ inputs.source }}

      - name: Setup Trivy ignore file
        run: cp build-logic/.trivyignore .trivyignore

      - name: Extract nested dependencies (Docker mode)
        if: inputs.mode == 'docker'
        run: |
          chmod +x build-logic/scripts/vulnerability-scanning/extract-nested-deps.sh
          build-logic/scripts/vulnerability-scanning/extract-nested-deps.sh \
            --mode=docker \
            --source="${{ inputs.source }}" \
            --scope="${{ inputs.scan_scope }}"
        env:
          EXTRACT_DIR: /tmp/extracted-deps

      - name: Extract nested dependencies (Tarball mode)
        if: inputs.mode == 'tarball'
        run: |
          chmod +x build-logic/scripts/vulnerability-scanning/extract-nested-deps.sh
          build-logic/scripts/vulnerability-scanning/extract-nested-deps.sh \
            --mode=tarball \
            --source="${{ steps.find-tarball.outputs.tarball_path }}" \
            --scope="${{ inputs.scan_scope }}"
        env:
          EXTRACT_DIR: /tmp/extracted-deps

      - name: Generate SBOM with Syft
        if: inputs.mode == 'docker' && inputs.generate_sbom
        uses: anchore/sbom-action@v0
        with:
          image: ${{ inputs.source }}
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: false

      - name: Install Trivy CLI
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Trivy surface scan (Docker mode)
        if: inputs.mode == 'docker'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ inputs.source }}
          format: json
          output: trivy-surface.json
          severity: HIGH,CRITICAL
          trivyignores: .trivyignore
          exit-code: "0"

      - name: Trivy deep scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: rootfs
          scan-ref: /tmp/extracted-deps
          format: json
          output: trivy-deep.json
          severity: HIGH,CRITICAL
          trivyignores: .trivyignore
          exit-code: "0"

      - name: Grype SBOM scan
        if: inputs.mode == 'docker' && inputs.generate_sbom
        uses: anchore/scan-action@v5
        with:
          sbom: sbom.spdx.json
          fail-build: false
          severity-cutoff: high
          output-format: json

      - name: Save Grype results
        if: inputs.mode == 'docker' && inputs.generate_sbom
        run: |
          chmod +x build-logic/scripts/vulnerability-scanning/save-grype-results.sh
          build-logic/scripts/vulnerability-scanning/save-grype-results.sh || true
        env:
          GRYPE_OUTPUT_FORMAT: json

      - name: Convert scan results
        id: convert
        run: |
          chmod +x build-logic/scripts/vulnerability-scanning/convert-scan-results.sh
          build-logic/scripts/vulnerability-scanning/convert-scan-results.sh

      - name: Analyze scan results
        id: analyze
        run: |
          chmod +x build-logic/scripts/vulnerability-scanning/analyze-scan-results.sh
          # Don't fail here, we'll check results in next step
          build-logic/scripts/vulnerability-scanning/analyze-scan-results.sh || true

          # Export outputs
          echo "total_vulns=${total_vulns:-0}" >> "$GITHUB_OUTPUT"
          echo "surface_vulns=${surface_vulns:-0}" >> "$GITHUB_OUTPUT"
          echo "deep_vulns=${deep_vulns:-0}" >> "$GITHUB_OUTPUT"
          echo "grype_vulns=${grype_vulns:-0}" >> "$GITHUB_OUTPUT"
        env:
          EXTRACT_DIR: /tmp/extracted-deps
          IMAGE_NAME: ${{ inputs.image_name || inputs.version || 'unknown' }}
          IMAGE_SUFFIX: ${{ inputs.image_tag && format(':{0}', inputs.image_tag) || '' }}

      - name: Create enhanced report
        run: |
          chmod +x build-logic/scripts/vulnerability-scanning/create-enhanced-report.sh
          build-logic/scripts/vulnerability-scanning/create-enhanced-report.sh \
            "${{ inputs.image_name || 'liquibase-secure' }}" \
            "${{ inputs.image_tag || inputs.version || 'unknown' }}"
        env:
          EXTRACT_DIR: /tmp/extracted-deps

      - name: Append to GitHub summary
        run: |
          chmod +x build-logic/scripts/vulnerability-scanning/append-github-summary.sh
          build-logic/scripts/vulnerability-scanning/append-github-summary.sh \
            "${{ inputs.image_name || 'liquibase-secure' }}" \
            "${{ inputs.image_tag || inputs.version || 'unknown' }}"
        env:
          EXTRACT_DIR: /tmp/extracted-deps

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-${{ inputs.image_name || 'secure' }}-${{ inputs.image_tag || inputs.version || 'unknown' }}
          path: |
            vulnerability-report-enhanced.md
            scan-summary.txt
            trivy-*.json
            trivy-*.sarif
            grype-results.*
          retention-days: 7

      - name: Upload SARIF to Security tab (deep scan)
        if: inputs.upload_sarif && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-deep.sarif
          category: ${{ inputs.sarif_category }}-deep
        continue-on-error: true

      - name: Upload SARIF to Security tab (surface scan)
        if: inputs.upload_sarif && inputs.mode == 'docker' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-surface.sarif
          category: ${{ inputs.sarif_category }}-surface
        continue-on-error: true

      - name: Check scan results
        id: check
        run: |
          total_vulns="${{ steps.analyze.outputs.total_vulns }}"
          total_vulns="${total_vulns:-0}"

          if [ "$total_vulns" -gt 0 ]; then
            echo "status=fail" >> "$GITHUB_OUTPUT"
            if [ "${{ inputs.fail_on_vulnerabilities }}" = "true" ]; then
              echo "::error::Found $total_vulns HIGH/CRITICAL vulnerabilities"
              exit 1
            else
              echo "::warning::Found $total_vulns HIGH/CRITICAL vulnerabilities (not failing due to configuration)"
            fi
          else
            echo "status=pass" >> "$GITHUB_OUTPUT"
            echo "No HIGH/CRITICAL vulnerabilities found"
          fi
