name: SonarCloud Coverage Merge

on:
  workflow_call:
    inputs:
      testedClassesModuleName:
        description: "Module containing tested classes (or 'root' for root module)"
        type: string
        default: "root"
      liquibaseBranchName:
        description: "Liquibase branch name for snapshot resolution"
        type: string
        default: ""
      mavenArgs:
        description: "Extra Maven arguments for sonar scan"
        type: string
        default: "-Dsonar.coverage.exclusions='**/test/**/*.*, **/pom.xml'"

jobs:
  sonar:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.event.after }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: temurin
          cache: maven

      - name: Configure Maven settings
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: |
            [
              {
                "id": "liquibase",
                "url": "https://maven.pkg.github.com/liquibase/liquibase",
                "releases": { "enabled": "true" },
                "snapshots": { "enabled": "true", "updatePolicy": "always" }
              },
              {
                "id": "liquibase-pro",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-pro",
                "releases": { "enabled": "true" },
                "snapshots": { "enabled": "true", "updatePolicy": "always" }
              }
            ]
          servers: |
            [
              {
                "id": "liquibase-pro",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                "id": "liquibase",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              }
            ]

      - name: Download unit test coverage
        uses: actions/download-artifact@v6
        with:
          name: liquibase-jacoco-test-results
          path: coverage/unit

      - name: Download integration test coverage
        uses: actions/download-artifact@v6
        with:
          pattern: liquibase-integration-jacoco-test-results-*
          path: coverage/integration/
          merge-multiple: false

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build classes for Sonar
        run: |
          VERSION_FLAG=""
          if [ -n "${{ inputs.liquibaseBranchName }}" ]; then
            VERSION_FLAG="-Dliquibase.version=${{ inputs.liquibaseBranchName }}-SNAPSHOT"
          fi
          mvn -B clean install -DskipTests -P 'sonar,!run-proguard' $VERSION_FLAG

      - name: Merge coverage reports
        env:
          TESTED_MODULE: ${{ inputs.testedClassesModuleName }}
        run: |
          mkdir -p target

          # Collect all jacoco.exec files with unique names
          i=0
          for f in $(find coverage -name "jacoco.exec"); do
            cp "$f" "target/jacoco-${i}.exec"
            i=$((i+1))
          done

          if [ "$i" -eq 0 ]; then
            echo "No coverage files found"
            exit 1
          fi

          echo "Found $i coverage files"

          # Download JaCoCo CLI
          wget -q https://github.com/jacoco/jacoco/releases/download/v0.8.12/jacoco-0.8.12.zip
          unzip -qq jacoco-0.8.12.zip -d jacoco-cli

          # Merge all exec files
          java -jar jacoco-cli/lib/jacococli.jar merge target/jacoco-*.exec --destfile target/merged.exec

          # Generate XML report
          if [ "$TESTED_MODULE" = "root" ]; then
            CLASSFILES="target/classes"
            SOURCEFILES="src"
          else
            CLASSFILES="${TESTED_MODULE}/target/classes"
            SOURCEFILES="${TESTED_MODULE}/src"
          fi

          java -jar jacoco-cli/lib/jacococli.jar report target/merged.exec \
            --classfiles "$CLASSFILES" \
            --sourcefiles "$SOURCEFILES" \
            --xml target/jacoco.xml

      - name: Sonar scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          LIQUIBASE_PRO_LICENSE_KEY: ${{ env.PRO_LICENSE_KEY }}
        run: |
          SONAR_ARGS=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SONAR_ARGS="-Dsonar.pullrequest.key=${{ github.event.pull_request.number }}"
            SONAR_ARGS="$SONAR_ARGS -Dsonar.pullrequest.branch=${{ github.event.pull_request.head.ref }}"
            SONAR_ARGS="$SONAR_ARGS -Dsonar.pullrequest.base=${{ github.event.pull_request.base.ref }}"
          else
            SONAR_ARGS="-Dsonar.branch.name=${{ github.ref_name }}"
          fi

          VERSION_FLAG=""
          if [ -n "${{ inputs.liquibaseBranchName }}" ]; then
            VERSION_FLAG="-Dliquibase.version=${{ inputs.liquibaseBranchName }}-SNAPSHOT"
          fi

          mvn -B sonar:sonar -P 'sonar,!run-proguard' -DskipTests \
            $VERSION_FLAG \
            ${{ inputs.mavenArgs }} \
            -Dsonar.scm.revision=${{ github.event.pull_request.head.sha || github.sha }} \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.java.coveragePlugin=jacoco \
            $SONAR_ARGS \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.organization=${{ github.repository_owner }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.scm.provider=git \
            -Daws.region=us-east-1
