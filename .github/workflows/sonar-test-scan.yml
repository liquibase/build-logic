name: Sonar Scan

on:
  workflow_call:
    inputs:
      thisBranchName:
        description: 'The name of the branch to be scanned'
        type: string
        required: true
      liquibaseBranchName:
        description: 'The name of the liquibase branch to be scanned'
        type: string
        required: true
      thisSha:
        description: 'The sha of the branch to be scanned'
        type: string
        required: true
      pullRequestNumber:
        description: 'The pull request number to be scanned'
        type: string
        required: false
      pullRequestBranchName:
        description: 'The name of the pull request branch to be scanned'
        type: string
        required: false
      pullRequestBaseBranchName:
        description: 'The name of the pull request base branch to be scanned'
        type: string
        required: false
      mavenArgs:
        description: 'The maven arguments to be passed to the mvn command'
        type: string
        required: false
      unitTestReportArtifactName:
        description: 'The name of the unit test report artifact'
        type: string
        required: false
      integrationTestReportArtifactName:
        description: 'The name of the integration test report artifact'
        type: string
        required: false
      coverageModuleName:
        description: 'The name of the coverage module'
        type: string
        required: false
      testedClassesModuleName:
        description: 'The name of the tested classes module'
        type: string
        required: false
      integrationTestsModuleName:
        description: 'The name of the integration tests module'
        type: string
        required: false

env:
  MAVEN_VERSION: '3.8.7'

jobs:
  sonar-push:
    name: Sonar Scan
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Wait for test reports
        run: sleep 30

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'
          overwrite-settings: false

      - name: Set up Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: Install mvnd
        run: |
          wget https://github.com/apache/maven-mvnd/releases/download/1.0-m7/maven-mvnd-1.0-m7-m39-linux-amd64.zip
          unzip maven-mvnd-1.0-m7-m39-linux-amd64.zip && mv maven-mvnd-1.0-m7-m39-linux-amd64 mvnd && chmod +x mvnd/bin/mvnd

      - name: Set up Maven settings.xml
        uses: whelk-io/maven-settings-xml-action@v21
        with:
          repositories: |
            [
              {
                "id": "liquibase",
                "url": "https://maven.pkg.github.com/liquibase/liquibase",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-pro",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-pro",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              }
            ]
          servers: |
            [
              {
                "id": "liquibase-pro",
                "username": "liquibot",
                "password": "${{ secrets.LIQUIBOT_PAT }}"
              },
              {
                "id": "liquibase",
                "username": "liquibot",
                "password": "${{ secrets.LIQUIBOT_PAT }}"
              }
            ]

      - name: Download unit tests report
        uses: dawidd6/action-download-artifact@v2.27.0
        with:
          name: ${{ inputs.unitTestReportArtifactName }}
          path: unit-tests
          if_no_artifact_found: warn

      - name: Download mssql integration tests report
        uses: dawidd6/action-download-artifact@v2.27.0
        with:
            name: ${{ inputs.integrationTestReportArtifactName }}-mssql
            path: integration-tests/mssql
            if_no_artifact_found: warn

      - name: Download mysql integration tests report
        uses: dawidd6/action-download-artifact@v2.27.0
        with:
            name: ${{ inputs.integrationTestReportArtifactName }}-mysql
            path: integration-tests/mysql
            if_no_artifact_found: warn

      - name: Download oracle integration tests report
        uses: dawidd6/action-download-artifact@v2.27.0
        with:
          name: ${{ inputs.integrationTestReportArtifactName }}-oracle
          path: integration-tests/oracle
          if_no_artifact_found: warn

      - name: Download postgresql integration tests report
        uses: dawidd6/action-download-artifact@v2.27.0
        with:
          name: ${{ inputs.integrationTestReportArtifactName }}-postgresql
          path: integration-tests/postgresql
          if_no_artifact_found: warn

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Merge integration and unit tests reports
        run: |
          mkdir ./${{ inputs.coverageModuleName }}/target

          mv unit-tests/${{ inputs.testedClassesModuleName }}/target/jacoco.exec ./${{ inputs.coverageModuleName }}/target/jacoco-unit.exec
          if [ -d "integration-tests/mssql" ]; then
            mv integration-tests/mssql/${{ inputs.integrationTestsModuleName }}/target/jacoco.exec ./${{ inputs.coverageModuleName }}/target/jacoco-mssql-aggregate.exec
          fi
          if [ -d "integration-tests/mysql" ]; then
            mv integration-tests/mysql/${{ inputs.integrationTestsModuleName }}/target/jacoco.exec ./${{ inputs.coverageModuleName }}/target/jacoco-mysql-aggregate.exec
          fi
          if [ -d "integration-tests/oracle" ]; then
            mv integration-tests/oracle/${{ inputs.integrationTestsModuleName }}/target/jacoco.exec ./${{ inputs.coverageModuleName }}/target/jacoco-oracle-aggregate.exec
          fi
          if [ -d "integration-tests/postgresql" ]; then
            mv integration-tests/postgresql/${{ inputs.integrationTestsModuleName }}/target/jacoco.exec ./${{ inputs.coverageModuleName }}/target/jacoco-postgresql-aggregate.exec
          fi

          ./mvnd/bin/mvnd -B verify -P 'unit,!run-proguard' -Dliquibase.version=${{ inputs.liquibaseBranchName }}-SNAPSHOT -T 1C
          wget -q https://github.com/jacoco/jacoco/releases/download/v0.8.10/jacoco-0.8.10.zip
          unzip ./jacoco-0.8.10.zip
          mv ./lib/jacococli.jar ./${{ inputs.coverageModuleName }}/target/jacococli.jar
          chmod +x ./${{ inputs.coverageModuleName }}/target/jacococli.jar
          cd ${{ inputs.coverageModuleName }}
          ./mvnd/bin/mvnd jacoco:merge@cli-merge-results
          cd ./target
          java -jar jacococli.jar report aggregate.exec --classfiles=../../${{ inputs.testedClassesModuleName }}/target/classdumps

      - name: Save Jacoco Mixed Results
        uses: actions/upload-artifact@v3
        with:
          name: liquibase-jacoco-mixed-report
          path: |
            ./${{ inputs.coverageModuleName }}/target/site

      - name: Sonar Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          LIQUIBASE_PRO_LICENSE_KEY: ${{ secrets.PRO_LICENSE_KEY }}
        run: |
          ./mvnd/bin/mvnd -B sonar:sonar -P '!run-proguard' -DskipTests -Dliquibase.version=${{ inputs.liquibaseBranchName }}-SNAPSHOT \
          ${{ inputs.mavenArgs  }} \
          -Dsonar.scm.revision=${{ inputs.thisSha }} \
          -Dsonar.login=$SONAR_TOKEN \
          -Dsonar.java.coveragePlugin=jacoco \
          -Dsonar.branch.name=${{ inputs.thisBranchName}} \
          -Dsonar.pullrequest.key=${{ inputs.pullRequestNumber}} \
          -Dsonar.pullrequest.branch=${{ inputs.pullRequestBranchName}} \
          -Dsonar.pullrequest.base=${{ inputs.pullRequestBaseBranchName }} \
          -Dsonar.pullrequest.provider=GitHub \
          -Dsonar.pullrequest.github.repository="${{ github.repository }}" \
          -Dsonar.pullrequest.github.endpoint='https://api.github.com/' \
          -Dsonar.qualitygate.wait=true \
          -Dsonar.organization=${{ github.repository_owner }} \
          -Dsonar.host.url='https://sonarcloud.io' \
          -Dsonar.scm.provider=git \
          -Daws.region="us-east-1" \
          -T 1C
